---
phase: 01-binary-discovery-model-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/spawner.py
  - tests/test_spawner.py
autonomous: true

must_haves:
  truths:
    - "discover_opencode_binary() returns the binary path when opencode is installed"
    - "discover_opencode_binary() raises FileNotFoundError with install instructions when opencode is not on PATH"
    - "validate_opencode_version() accepts v1.1.52 and higher"
    - "validate_opencode_version() rejects versions below v1.1.52 with a clear error naming the minimum"
    - "validate_opencode_version() handles version output formats like '1.1.52', 'v1.1.52', 'opencode v1.1.52'"
    - "translate_model('sonnet') returns the correct provider/model string for the given provider"
    - "translate_model('moonshot-ai/kimi-k2.5') passes through unchanged"
    - "get_provider_config() returns config with {env:VAR_NAME} credential references, never real keys"
    - "get_credential_env_var() returns the correct env var name for each supported provider"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "discover_opencode_binary, validate_opencode_version, translate_model, get_provider_config, get_credential_env_var"
      contains: "def discover_opencode_binary"
    - path: "tests/test_spawner.py"
      provides: "Tests for all new functions"
      contains: "TestDiscoverOpencodeBinary"
  key_links:
    - from: "src/claude_teams/spawner.py"
      to: "subprocess.run"
      via: "validate_opencode_version calls subprocess"
      pattern: 'subprocess\.run.*--version'
    - from: "src/claude_teams/spawner.py"
      to: "shutil.which"
      via: "discover_opencode_binary calls shutil.which('opencode')"
      pattern: 'shutil\.which.*opencode'
---

<objective>
Add OpenCode binary discovery with version validation, model name translation, and multi-provider configuration functions to the spawner module.

Purpose: These are the foundational functions that all later phases depend on. Binary discovery replaces `discover_claude_binary()`. Model translation maps Claude aliases (sonnet/opus/haiku) to Kimi K2.5 provider strings. Provider config generates credential-safe configuration blocks.

Output: New functions in `spawner.py` with comprehensive unit tests. The old `discover_claude_binary()` is NOT removed yet (Phase 8 handles legacy cleanup).
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-binary-discovery-model-configuration/01-RESEARCH.md
@src/claude_teams/spawner.py
@tests/test_spawner.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenCode discovery and model translation functions to spawner.py</name>
  <files>src/claude_teams/spawner.py</files>
  <action>
Add the following functions to `src/claude_teams/spawner.py`, BELOW the existing code (do NOT remove or modify any existing functions -- those are cleaned up in Phase 8):

1. **Module-level constants** (add after existing imports):
   - `MINIMUM_OPENCODE_VERSION = (1, 1, 52)` -- tuple for dependency-free comparison
   - `DEFAULT_PROVIDER = "moonshot-ai"`
   - `MODEL_ALIASES: dict[str, str]` mapping "sonnet", "opus", "haiku" all to "kimi-k2.5" (document WHY all map to same model: "Kimi K2.5 is the only supported model; all Claude aliases are equivalent")
   - `PROVIDER_MODEL_MAP: dict[str, str]` mapping provider names to their full model ID:
     - `"moonshot-ai"` -> `"moonshot-ai/kimi-k2.5"`
     - `"moonshot-ai-china"` -> `"moonshot-ai-china/kimi-k2.5"`
     - `"openrouter"` -> `"openrouter/moonshotai/kimi-k2.5"` (note: no hyphen in `moonshotai` -- OpenRouter naming convention)
     - `"novita"` -> `"novita/moonshotai/kimi-k2.5"`
   - `PROVIDER_CONFIGS: dict[str, dict]` with full provider config blocks per research Pattern 3 (moonshot-ai, moonshot-ai-china, openrouter, novita). Novita must include `npm`, `name`, `options.baseURL`, and `models` with context/output limits. All configs use `{env:VAR_NAME}` syntax for API keys.
   - `_PROVIDER_ENV_VARS: dict[str, str]` mapping provider to env var name (moonshot-ai -> MOONSHOT_API_KEY, etc.)

2. **`discover_opencode_binary() -> str`**: Use `shutil.which("opencode")`. If None, raise `FileNotFoundError` with message mentioning install URL `https://opencode.ai`. If found, call `validate_opencode_version(path)` and return path.

3. **`validate_opencode_version(binary_path: str) -> str`**: Run `subprocess.run([binary_path, "--version"], capture_output=True, text=True, timeout=10)`. Handle `TimeoutExpired` (raise RuntimeError about hung binary) and `FileNotFoundError` (raise RuntimeError). Parse version from stdout or stderr using `re.search(r"v?(\d+\.\d+\.\d+)", output)`. If no match, raise RuntimeError with the raw output. Compare using tuple: `tuple(int(x) for x in version_str.split("."))`. If below MINIMUM_OPENCODE_VERSION, raise RuntimeError naming the current version, the minimum, and an update command. Return the version string on success.

   Use `re` import (already available in the module if not, add it). Do NOT use `packaging.version` -- use tuple comparison per research recommendation to avoid dependency risk.

4. **`translate_model(model_alias: str, provider: str = DEFAULT_PROVIDER) -> str`**: If `"/"` in model_alias, return it unchanged (passthrough for direct provider/model strings). Otherwise, resolve alias via MODEL_ALIASES (fall through to identity if not found). Then look up provider in PROVIDER_MODEL_MAP; if found return the mapped value. Fallback: `f"{provider}/{model_name}"`.

5. **`get_provider_config(provider: str) -> dict`**: Look up provider in PROVIDER_CONFIGS. If not found, raise `ValueError` listing supported providers. Return `{provider: PROVIDER_CONFIGS[provider]}`.

6. **`get_credential_env_var(provider: str) -> str`**: Look up provider in _PROVIDER_ENV_VARS. Fallback for unknown providers: `f"{provider.upper().replace('-', '_')}_API_KEY"`.

Import `re` at the top of the file if not already imported.
  </action>
  <verify>
Run `python -c "from claude_teams.spawner import discover_opencode_binary, validate_opencode_version, translate_model, get_provider_config, get_credential_env_var"` -- should import without error.

Run `python -c "from claude_teams.spawner import PROVIDER_MODEL_MAP, MODEL_ALIASES, PROVIDER_CONFIGS; print(len(PROVIDER_MODEL_MAP), len(MODEL_ALIASES), len(PROVIDER_CONFIGS))"` -- should print `4 3 4`.
  </verify>
  <done>
All 6 items above exist in spawner.py. Constants and functions are importable. No existing functions modified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for all new spawner functions</name>
  <files>tests/test_spawner.py</files>
  <action>
Add the following test classes to `tests/test_spawner.py`, BELOW the existing test classes. Add new imports at the top: `validate_opencode_version`, `translate_model`, `get_provider_config`, `get_credential_env_var`, `PROVIDER_CONFIGS`, `PROVIDER_MODEL_MAP`, `MODEL_ALIASES`, `MINIMUM_OPENCODE_VERSION` from `claude_teams.spawner`. Also add `import subprocess` if not already imported.

**TestDiscoverOpencodeBinary** (replaces nothing -- TestDiscoverClaudeBinary stays for now):
- `test_found_and_valid_version`: Mock `shutil.which` returning `/usr/local/bin/opencode` AND mock `subprocess.run` returning stdout `"1.1.52\n"`. Assert returns `/usr/local/bin/opencode`. Assert `mock_which.assert_called_once_with("opencode")`.
- `test_not_found`: Mock `shutil.which` returning None. Assert raises `FileNotFoundError` matching `"opencode"`.
- `test_version_too_old`: Mock `shutil.which` returning a path, mock `subprocess.run` returning stdout `"1.1.40\n"`. Assert raises `RuntimeError` matching `"too old"`.
- `test_version_with_v_prefix`: Mock both, subprocess returns `"v1.1.53\n"`. Assert returns path successfully.
- `test_version_with_verbose_output`: Mock both, subprocess returns `"opencode version v1.1.52\n"`. Assert returns path successfully.

**TestValidateOpencodeVersion**:
- `test_valid_version`: Mock subprocess returning `"1.1.52\n"`. Assert returns `"1.1.52"`.
- `test_newer_version`: Mock subprocess returning `"2.0.0\n"`. Assert returns `"2.0.0"`.
- `test_old_version_raises`: Mock subprocess returning `"1.1.49\n"`. Assert raises `RuntimeError` matching `"too old"`.
- `test_unparseable_output_raises`: Mock subprocess returning `"unknown\n"`. Assert raises `RuntimeError` matching `"Could not parse"`.
- `test_timeout_raises`: Mock subprocess raising `subprocess.TimeoutExpired(cmd="opencode", timeout=10)`. Assert raises `RuntimeError` matching `"Timed out"`.
- `test_binary_not_found_raises`: Mock subprocess raising `FileNotFoundError`. Assert raises `RuntimeError`.

**TestTranslateModel**:
- `test_sonnet_moonshot`: `translate_model("sonnet", "moonshot-ai")` == `"moonshot-ai/kimi-k2.5"`
- `test_opus_moonshot`: `translate_model("opus", "moonshot-ai")` == `"moonshot-ai/kimi-k2.5"`
- `test_haiku_openrouter`: `translate_model("haiku", "openrouter")` == `"openrouter/moonshotai/kimi-k2.5"`
- `test_sonnet_novita`: `translate_model("sonnet", "novita")` == `"novita/moonshotai/kimi-k2.5"`
- `test_passthrough_provider_model`: `translate_model("moonshot-ai/kimi-k2.5")` == `"moonshot-ai/kimi-k2.5"` (unchanged)
- `test_passthrough_arbitrary`: `translate_model("custom/my-model")` == `"custom/my-model"`
- `test_unknown_alias_as_model_name`: `translate_model("kimi-k2.5", "moonshot-ai")` == `"moonshot-ai/kimi-k2.5"` (falls through alias lookup)
- `test_default_provider`: `translate_model("sonnet")` == `"moonshot-ai/kimi-k2.5"` (uses DEFAULT_PROVIDER)

**TestGetProviderConfig**:
- `test_moonshot_ai`: Assert `"moonshot-ai"` in result, apiKey is `"{env:MOONSHOT_API_KEY}"`.
- `test_openrouter`: Assert apiKey is `"{env:OPENROUTER_API_KEY}"`.
- `test_novita_has_base_url`: Assert baseURL is `"https://api.novita.ai/openai"`.
- `test_novita_has_npm_package`: Assert `"npm"` key exists in novita config.
- `test_unknown_provider_raises`: Assert raises `ValueError` matching `"Unknown provider"`.
- `test_no_hardcoded_keys`: Iterate all providers in PROVIDER_CONFIGS, call `get_provider_config`, stringify the result, assert `"sk-"` not in it and `"{env:"` is in it.

**TestGetCredentialEnvVar**:
- `test_moonshot`: Returns `"MOONSHOT_API_KEY"`.
- `test_openrouter`: Returns `"OPENROUTER_API_KEY"`.
- `test_novita`: Returns `"NOVITA_API_KEY"`.
- `test_unknown_fallback`: `get_credential_env_var("my-custom")` returns `"MY_CUSTOM_API_KEY"`.

Use `@patch("claude_teams.spawner.shutil.which")` and `@patch("claude_teams.spawner.subprocess.run")` decorators consistent with existing test style. Follow the existing Arrange/Act/Assert pattern with test classes.
  </action>
  <verify>
Run `pytest tests/test_spawner.py -v` -- all tests pass (both old and new).
  </verify>
  <done>
All test classes exist. Tests cover: binary discovery (5 tests), version validation (6 tests), model translation (8 tests), provider config (6 tests), credential env var (4 tests). All pass alongside existing tests.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_spawner.py -v` -- all tests pass (both existing Claude binary tests AND new OpenCode tests)
2. `python -c "from claude_teams.spawner import discover_opencode_binary, translate_model, get_provider_config"` -- imports succeed
3. Existing tests in other modules still pass: `pytest tests/ -v`
</verification>

<success_criteria>
- discover_opencode_binary() finds binary and validates version >= 1.1.52
- validate_opencode_version() parses multiple output formats, rejects old versions
- translate_model() maps sonnet/opus/haiku to provider-specific kimi-k2.5 strings
- translate_model() passes through direct provider/model strings unchanged
- get_provider_config() returns credential-safe configs for all 4 providers
- No existing code modified -- all additions are new functions/constants
- All tests pass (29+ new tests across 5 test classes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-binary-discovery-model-configuration/01-01-SUMMARY.md`
</output>
