---
phase: 01-binary-discovery-model-configuration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/claude_teams/server.py
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "Server lifespan discovers OpenCode binary (not Claude) and stores it as 'opencode_binary' in context"
    - "spawn_teammate_tool accepts any string model parameter (not just Literal['sonnet','opus','haiku'])"
    - "spawn_teammate_tool translates model alias to provider/model string via translate_model() before passing to spawn_teammate"
    - "All existing server tests still pass (no regressions)"
    - "Server description references OpenCode, not Claude Code"
  artifacts:
    - path: "src/claude_teams/server.py"
      provides: "Updated lifespan, spawn_teammate_tool, and MCP server description"
      contains: "discover_opencode_binary"
    - path: "tests/test_server.py"
      provides: "Updated test fixture and new model translation tests"
      contains: "discover_opencode_binary"
  key_links:
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "imports discover_opencode_binary and translate_model"
      pattern: "from claude_teams.spawner import.*discover_opencode_binary"
    - from: "src/claude_teams/server.py"
      to: "translate_model"
      via: "spawn_teammate_tool calls translate_model before spawning"
      pattern: "translate_model"
---

<objective>
Wire the new OpenCode discovery and model translation functions into the MCP server layer.

Purpose: The server is the entry point -- its lifespan function runs discovery at startup, and spawn_teammate_tool uses model translation at spawn time. This plan connects the Phase 1 foundation (Plan 01) to the actual server behavior so that the system uses OpenCode instead of Claude Code for binary discovery and model resolution.

Output: Updated `server.py` using OpenCode discovery and model translation, with passing tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-binary-discovery-model-configuration/01-RESEARCH.md
@.planning/phases/01-binary-discovery-model-configuration/01-01-SUMMARY.md
@src/claude_teams/server.py
@src/claude_teams/spawner.py
@tests/test_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update server.py to use OpenCode discovery and model translation</name>
  <files>src/claude_teams/server.py</files>
  <action>
Make the following targeted changes to `src/claude_teams/server.py`:

1. **Update imports** (line 19): Change the import from `claude_teams.spawner` to include the new functions:
   ```python
   from claude_teams.spawner import discover_opencode_binary, kill_tmux_pane, spawn_teammate, translate_model
   ```
   Remove `discover_claude_binary` from the import. Keep `kill_tmux_pane` and `spawn_teammate`.

2. **Update lifespan function** (lines 22-26): Replace `discover_claude_binary()` with `discover_opencode_binary()`. Change the context key from `"claude_binary"` to `"opencode_binary"`. Add a `"provider"` key defaulting to `"moonshot-ai"` (from `DEFAULT_PROVIDER` imported from spawner, or just hardcode `"moonshot-ai"` to keep it simple -- can be made configurable later):
   ```python
   @lifespan
   async def app_lifespan(server):
       opencode_binary = discover_opencode_binary()
       session_id = str(uuid.uuid4())
       yield {"opencode_binary": opencode_binary, "session_id": session_id, "active_team": None, "provider": "moonshot-ai"}
   ```

3. **Update MCP server description** (lines 29-35): Change `instructions` text from "Claude Code agent teams" to "OpenCode agent teams with Kimi K2.5". Change from "Manages team creation, teammate spawning, messaging, and task tracking." to "Manages team creation, teammate spawning with Kimi K2.5, messaging, and task tracking."

4. **Update spawn_teammate_tool** (lines 72-100):
   - Change `model` parameter type from `Literal["sonnet", "opus", "haiku"]` to `str` with default `"sonnet"`. Add comment: `# Accepts: "sonnet", "opus", "haiku", or "provider/model"`
   - Update the docstring to mention OpenCode instead of Claude Code.
   - Change `ls["claude_binary"]` to `ls["opencode_binary"]`.
   - Before calling `spawn_teammate`, resolve the model: `resolved_model = translate_model(model, provider=ls.get("provider", "moonshot-ai"))`.
   - Pass `resolved_model` (not `model`) to `spawn_teammate()`.

5. **Do NOT change** `force_kill_teammate` or any other tool. The old `build_spawn_command` with Claude flags still exists in spawner.py and will be replaced in Phase 3/8. The `spawn_teammate` function in spawner.py still calls `build_spawn_command` internally -- that is fine for now. The model string passed to spawn_teammate will just be the resolved provider/model string stored in the TeammateMember.
  </action>
  <verify>
Run `python -c "from claude_teams.server import mcp, app_lifespan; print('OK')"` -- imports succeed.

Run `python -c "import inspect; from claude_teams.server import spawn_teammate_tool; sig = inspect.signature(spawn_teammate_tool); print(sig.parameters['model'].annotation)"` -- should show `str`, not `Literal`.
  </verify>
  <done>
server.py uses discover_opencode_binary in lifespan, stores as "opencode_binary". spawn_teammate_tool accepts str model param, calls translate_model before spawning. MCP description references OpenCode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test_server.py fixture and add model translation wiring tests</name>
  <files>tests/test_server.py</files>
  <action>
Make the following changes to `tests/test_server.py`:

1. **Update the client fixture** (line 31-42): Change the monkeypatch for discovery from:
   ```python
   monkeypatch.setattr("claude_teams.server.discover_claude_binary", lambda: "/usr/bin/echo")
   ```
   to:
   ```python
   monkeypatch.setattr("claude_teams.server.discover_opencode_binary", lambda: "/usr/bin/echo")
   ```
   This is the critical wiring change -- without it, all server tests will fail because `discover_opencode_binary` is now called in lifespan.

2. **Add a TestModelTranslationWiring class** with tests that verify the spawn_teammate_tool correctly translates model aliases. These tests should mock the spawner to avoid actual tmux calls:

   ```python
   class TestModelTranslationWiring:
       async def test_spawn_passes_translated_model(self, client: Client):
           """Verify that spawn_teammate_tool translates 'sonnet' to provider/model format."""
           await client.call_tool("team_create", {"team_name": "tm1"})
           # Mock spawn_teammate to capture the model argument without actually spawning
           import unittest.mock
           with unittest.mock.patch("claude_teams.server.spawn_teammate") as mock_spawn:
               mock_spawn.return_value = TeammateMember(
                   agent_id="worker@tm1", name="worker", agent_type="general-purpose",
                   model="moonshot-ai/kimi-k2.5", prompt="do work", color="blue",
                   joined_at=0, tmux_pane_id="%1", cwd="/tmp",
               )
               await client.call_tool("spawn_teammate", {
                   "team_name": "tm1", "name": "worker", "prompt": "do work", "model": "sonnet",
               })
               # The model passed to spawn_teammate should be the translated version
               call_kwargs = mock_spawn.call_args
               assert call_kwargs is not None
               # Check that 'model' kwarg is the translated string
               if call_kwargs.kwargs:
                   assert call_kwargs.kwargs.get("model") == "moonshot-ai/kimi-k2.5"
               else:
                   # positional args -- model is typically a kwarg
                   pass

       async def test_spawn_passes_through_direct_model(self, client: Client):
           """Verify that a direct provider/model string passes through unchanged."""
           await client.call_tool("team_create", {"team_name": "tm2"})
           import unittest.mock
           with unittest.mock.patch("claude_teams.server.spawn_teammate") as mock_spawn:
               mock_spawn.return_value = TeammateMember(
                   agent_id="worker@tm2", name="worker", agent_type="general-purpose",
                   model="openrouter/moonshotai/kimi-k2.5", prompt="do work", color="blue",
                   joined_at=0, tmux_pane_id="%1", cwd="/tmp",
               )
               await client.call_tool("spawn_teammate", {
                   "team_name": "tm2", "name": "worker", "prompt": "do work",
                   "model": "openrouter/moonshotai/kimi-k2.5",
               })
               call_kwargs = mock_spawn.call_args
               assert call_kwargs is not None
               if call_kwargs.kwargs:
                   assert call_kwargs.kwargs.get("model") == "openrouter/moonshotai/kimi-k2.5"
   ```

   Note: The mock is on `claude_teams.server.spawn_teammate` (not `claude_teams.spawner.spawn_teammate`) because that is the reference the server module holds after import.

3. **Verify all existing tests still reference the correct binary key.** The test fixture monkeypatches `discover_opencode_binary` -- this is the only place that needs to change. The rest of the server tests do not directly reference `claude_binary` or `opencode_binary` so they should pass as-is.
  </action>
  <verify>
Run `pytest tests/test_server.py -v` -- all tests pass (existing + new model translation tests).

Run `pytest tests/ -v` -- full test suite passes with no regressions.
  </verify>
  <done>
test_server.py fixture uses discover_opencode_binary mock. New TestModelTranslationWiring class verifies model alias translation flows through spawn_teammate_tool correctly. All existing server tests pass without modification.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_server.py -v` -- all tests pass
2. `pytest tests/test_spawner.py -v` -- all tests pass
3. `pytest tests/ -v` -- full suite passes, no regressions
4. Grep for `discover_claude_binary` in server.py -- should NOT be found (removed from import)
5. Grep for `discover_opencode_binary` in server.py -- should be found (in import and lifespan)
6. Grep for `translate_model` in server.py -- should be found (in import and spawn_teammate_tool)
</verification>

<success_criteria>
- Server lifespan calls discover_opencode_binary() instead of discover_claude_binary()
- Lifespan context uses "opencode_binary" key (not "claude_binary")
- spawn_teammate_tool model parameter is str (not Literal)
- spawn_teammate_tool calls translate_model() before passing model to spawn_teammate()
- MCP server description references OpenCode, not Claude Code
- All existing tests pass with updated fixture
- New tests verify model translation wiring
</success_criteria>

<output>
After completion, create `.planning/phases/01-binary-discovery-model-configuration/01-02-SUMMARY.md`
</output>
