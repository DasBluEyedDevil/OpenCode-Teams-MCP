---
phase: 04-mcp-communication-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_mcp_agent_tools.py
  - src/claude_teams/config_gen.py
autonomous: true

must_haves:
  truths:
    - "A spawned agent can call read_inbox with its own name and receive messages"
    - "A spawned agent can call send_message with sender set to its name (not team-lead)"
    - "A spawned agent can call task_create, task_update, task_list, task_get and receive correct responses"
    - "The system prompt in config_gen.py instructs agents to use sender=<name> when calling send_message"
  artifacts:
    - path: "tests/test_mcp_agent_tools.py"
      provides: "Integration tests for single-agent MCP tool access"
      min_lines: 120
  key_links:
    - from: "tests/test_mcp_agent_tools.py"
      to: "src/claude_teams/server.py"
      via: "fastmcp.Client(mcp) tool calls"
      pattern: "client\\.call_tool"
    - from: "src/claude_teams/config_gen.py"
      to: "send_message tool"
      via: "system prompt instructions"
      pattern: 'sender.*=.*\"{name}\"'
---

<objective>
Validate that every MCP tool callable by a spawned agent works correctly from the agent's perspective.

Purpose: Confirm MCP-02 requirement -- agents can access read_inbox, send_message, and task_* tools and receive correct responses. Also verify the system prompt guides agents to use the correct `sender` parameter.
Output: New test file `tests/test_mcp_agent_tools.py` with passing tests, and (if needed) a fix to the send_message example in `config_gen.py`.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/test_server.py
@src/claude_teams/server.py
@src/claude_teams/config_gen.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Single-agent MCP tool access integration tests</name>
  <files>tests/test_mcp_agent_tools.py</files>
  <action>
Create a new test file `tests/test_mcp_agent_tools.py` with a class `TestSingleAgentToolAccess` that validates each MCP tool from a spawned agent's perspective.

Use the same `client` fixture pattern from `test_server.py`:
- monkeypatch `teams.TEAMS_DIR`, `teams.TASKS_DIR`, `tasks.TASKS_DIR`, `messaging.TEAMS_DIR` to `tmp_path`
- monkeypatch `discover_opencode_binary` to return "/usr/bin/echo"
- Create dirs and `Client(mcp)` context

Reuse the `_make_teammate` helper and `_data` extractor from `test_server.py` -- import from there or duplicate locally (duplicating is cleaner for isolation).

Write these test methods:

1. `test_agent_can_read_own_inbox` -- Create team, add agent "alice", send message to alice from team-lead, then call `read_inbox(team_name, agent_name="alice")` and assert the message is returned with correct `from` and `text` fields.

2. `test_agent_can_send_message_to_teammate` -- Create team, add agents "alice" and "bob", then call `send_message(team_name, type="message", recipient="bob", content="hello from alice", summary="greeting", sender="alice")` and assert success. Then call `read_inbox` for "bob" and verify the message has `from="alice"` and `text="hello from alice"`.

3. `test_agent_can_create_task` -- Create team, call `task_create(team_name, subject="test task", description="do something")`, assert response contains `id` and `subject` fields.

4. `test_agent_can_update_task_status` -- Create team, create a task, call `task_update(team_name, task_id, status="in_progress")`, assert response shows `status="in_progress"`.

5. `test_agent_can_claim_task_via_owner` -- Create team, add agent "alice", create a task, call `task_update(team_name, task_id, owner="alice")`, assert response shows `owner="alice"`. Then verify alice's inbox has a task_assignment message.

6. `test_agent_can_list_tasks` -- Create team, create 2 tasks, call `task_list(team_name)`, assert 2 tasks returned.

7. `test_agent_can_get_task_by_id` -- Create team, create a task, call `task_get(team_name, task_id)`, assert correct task returned with matching id and subject.

8. `test_agent_inbox_starts_empty` -- Create team, add agent "alice", call `read_inbox(team_name, agent_name="alice")`, assert empty list.

Key details:
- The `sender` parameter on `send_message` defaults to "team-lead" in the MCP tool. Agents must pass `sender="alice"` explicitly. Test both the explicit sender case and the default.
- Use `json.loads(result.content[0].text)` pattern (via `_data` helper) to extract tool results.
- Each test should use a unique team name to avoid cross-test interference (existing pattern in test_server.py).
  </action>
  <verify>Run `pytest tests/test_mcp_agent_tools.py -v` -- all tests pass.</verify>
  <done>8 tests pass, covering read_inbox, send_message (with explicit sender), task_create, task_update (status + owner), task_list, task_get from agent perspective.</done>
</task>

<task type="auto">
  <name>Task 2: Fix send_message sender in config_gen system prompt</name>
  <files>src/claude_teams/config_gen.py</files>
  <action>
Inspect the `send_message` example in `config_gen.py` (lines ~87-97). The current example uses parameters `from_agent` and `to_agent` which are NOT the actual MCP tool parameter names. The real `send_message` tool in `server.py` takes: `team_name`, `type`, `recipient`, `content`, `summary`, `sender` (defaults to "team-lead").

Fix the system prompt's send_message example to use the correct parameter names:
```
claude-teams_send_message(
    team_name="{team_name}",
    type="message",
    recipient="team-lead",
    content="Status update: task completed",
    summary="status update",
    sender="{name}"
)
```

This is critical because if agents use the wrong parameter names, the MCP tool call will fail. The `sender="{name}"` is especially important so messages are attributed to the correct agent (per research pitfall #1).

After fixing, run existing tests to ensure nothing breaks:
- `pytest tests/test_config_gen.py -v` (the body content assertions should still pass since they check for `claude-teams_send_message` presence, not exact parameters)
  </action>
  <verify>Run `pytest tests/test_config_gen.py -v` -- all tests pass. Manually inspect the generated config to verify `sender="{name}"` appears in the send_message example.</verify>
  <done>The config_gen.py system prompt contains correct send_message parameter names (type, recipient, content, summary, sender) and explicitly sets sender="{name}" so agents identify themselves.</done>
</task>

</tasks>

<verification>
- `pytest tests/test_mcp_agent_tools.py tests/test_config_gen.py -v` -- all tests pass
- The system prompt in config_gen.py uses correct MCP tool parameter names for send_message
- Every MCP tool callable by an agent (read_inbox, send_message, task_create, task_update, task_list, task_get) has at least one passing test from the agent's perspective
</verification>

<success_criteria>
- All 8+ new tests in test_mcp_agent_tools.py pass
- config_gen.py send_message example uses correct parameter names with sender="{name}"
- Existing test suite (`pytest tests/`) continues to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-communication-validation/04-01-SUMMARY.md`
</output>
