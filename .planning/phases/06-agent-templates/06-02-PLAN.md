---
phase: 06-agent-templates
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/claude_teams/spawner.py
  - src/claude_teams/server.py
  - tests/test_spawner.py
  - tests/test_server.py
autonomous: true

must_haves:
  truths:
    - "spawn_teammate accepts role_instructions and custom_instructions and passes them to generate_agent_config"
    - "spawn_teammate_tool accepts optional template parameter that looks up role_instructions from templates registry"
    - "Spawning with template='researcher' produces a config file containing researcher role instructions"
    - "Spawning with an unknown template name raises a ToolError listing available templates"
    - "Spawning without a template produces identical config to pre-Phase-6 behavior"
    - "list_agent_templates MCP tool returns all 4 templates with name and description"
    - "subagent_type is set to the template name when a template is used, 'general-purpose' otherwise"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "spawn_teammate with role_instructions and custom_instructions params"
      contains: "role_instructions"
    - path: "src/claude_teams/server.py"
      provides: "spawn_teammate_tool with template param, list_agent_templates MCP tool"
      contains: "list_agent_templates"
    - path: "tests/test_spawner.py"
      provides: "Tests for template wiring in spawn flow"
      contains: "TestSpawnWithTemplate"
    - path: "tests/test_server.py"
      provides: "MCP integration tests for template param and listing tool"
      contains: "TestListAgentTemplates"
  key_links:
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/templates.py"
      via: "get_template() and list_templates() imports"
      pattern: "from claude_teams.templates import"
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "role_instructions kwarg passed to spawn_teammate"
      pattern: "role_instructions="
    - from: "src/claude_teams/spawner.py"
      to: "src/claude_teams/config_gen.py"
      via: "role_instructions and custom_instructions kwargs passed to generate_agent_config"
      pattern: "generate_agent_config.*role_instructions"
---

<objective>
Wire template lookup into the spawn flow and expose template functionality via MCP tools.

Purpose: Connects the template registry (from Plan 01) through spawner.py to server.py, so agents spawned with a template receive role-specific system prompts. Also adds a list_agent_templates MCP tool for template discovery.

Output: Modified spawner.py and server.py with template wiring, new list_agent_templates tool, comprehensive tests.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-templates/06-RESEARCH.md
@.planning/phases/06-agent-templates/06-01-SUMMARY.md
@src/claude_teams/spawner.py
@src/claude_teams/server.py
@src/claude_teams/templates.py
@tests/test_spawner.py
@tests/test_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire template params through spawner.py and add tests</name>
  <files>src/claude_teams/spawner.py, tests/test_spawner.py</files>
  <action>
Modify `spawn_teammate()` in `src/claude_teams/spawner.py`:

1. **Add two keyword-only parameters** after `subagent_type`:
   ```python
   def spawn_teammate(
       team_name: str,
       name: str,
       prompt: str,
       opencode_binary: str,
       lead_session_id: str,
       *,
       model: str = "sonnet",
       subagent_type: str = "general-purpose",
       role_instructions: str = "",
       custom_instructions: str = "",
       cwd: str | None = None,
       plan_mode_required: bool = False,
       base_dir: Path | None = None,
       project_dir: Path | None = None,
   ) -> TeammateMember:
   ```

2. **Pass the new params to generate_agent_config** (around line 212):
   ```python
   config_content = generate_agent_config(
       agent_id=member.agent_id,
       name=name,
       team_name=team_name,
       color=color,
       model=model,
       role_instructions=role_instructions,
       custom_instructions=custom_instructions,
   )
   ```

   No other changes to spawner.py are needed. The function signature change is backward-compatible (keyword-only with defaults).

Add to `tests/test_spawner.py` a new test class `TestSpawnWithTemplate`:

- `test_spawn_passes_role_instructions_to_config_gen`: Mock subprocess, call spawn_teammate with role_instructions="# Role: Tester\n\nTest stuff.", read the generated config file from project_dir/.opencode/agents/<name>.md, assert "# Role: Tester" appears in the file content.

- `test_spawn_passes_custom_instructions_to_config_gen`: Same setup, pass custom_instructions="Focus on edge cases.", assert "Focus on edge cases." appears in the generated config file.

- `test_spawn_without_template_produces_clean_config`: Call spawn_teammate without role_instructions or custom_instructions, read the config file, assert it does NOT contain "# Role:" or "# Additional Instructions".

- `test_spawn_with_both_role_and_custom_instructions`: Pass both params, verify both appear in the generated config file with correct ordering (role before custom, both before Communication Protocol).

All tests should follow the existing TestConfigGenIntegration pattern: use `@patch("claude_teams.spawner.subprocess")`, create team with `teams.create_team()`, pass `base_dir=tmp_claude_dir` and `project_dir=tmp_path/"project"`.
  </action>
  <verify>
Run `python -m pytest tests/test_spawner.py -v` -- all tests pass (existing + 4 new).
Run `python -m pytest tests/test_spawner.py::TestSpawnWithTemplate -v` -- 4 new tests pass.
  </verify>
  <done>
spawn_teammate() accepts role_instructions and custom_instructions and forwards them to generate_agent_config(). Generated config files contain template content when provided. 4 new spawner tests pass. All existing spawner tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add template parameter to spawn_teammate_tool and list_agent_templates MCP tool</name>
  <files>src/claude_teams/server.py, tests/test_server.py</files>
  <action>
Modify `src/claude_teams/server.py`:

1. **Add imports** at the top:
   ```python
   from claude_teams.templates import get_template, list_templates, TEMPLATES
   ```

2. **Modify spawn_teammate_tool** -- add `template` parameter, remove `subagent_type` as a direct tool param (it becomes derived):
   ```python
   @mcp.tool(name="spawn_teammate")
   def spawn_teammate_tool(
       team_name: str,
       name: str,
       prompt: str,
       ctx: Context,
       model: str = "sonnet",
       template: str = "",  # "researcher", "implementer", "reviewer", "tester", or "" for generic
       plan_mode_required: bool = False,
   ) -> dict:
       """Spawn a new OpenCode teammate in a tmux pane. The teammate receives
       its initial prompt via inbox and begins working autonomously. Names must
       be unique within the team. Use template parameter to assign a role
       (researcher, implementer, reviewer, tester) with role-specific system
       prompt instructions. Use list_agent_templates to see available templates."""
       ls = _get_lifespan(ctx)
       resolved_model = translate_model(model, provider=ls.get("provider", "moonshot-ai"))

       # Template lookup
       role_instructions = ""
       if template:
           tmpl = get_template(template)
           if tmpl is None:
               available = ", ".join(sorted(TEMPLATES.keys()))
               raise ToolError(f"Unknown template: {template!r}. Available: {available}")
           role_instructions = tmpl.role_instructions

       member = spawn_teammate(
           team_name=team_name,
           name=name,
           prompt=prompt,
           opencode_binary=ls["opencode_binary"],
           lead_session_id=ls["session_id"],
           model=resolved_model,
           subagent_type=template or "general-purpose",
           role_instructions=role_instructions,
           plan_mode_required=plan_mode_required,
           project_dir=Path.cwd(),
       )
       return SpawnResult(
           agent_id=member.agent_id,
           name=member.name,
           team_name=team_name,
       ).model_dump()
   ```

   Key changes:
   - Replace `subagent_type` param with `template` param (the old `subagent_type` is derived: set to template name if template provided, "general-purpose" otherwise)
   - Add template lookup with error handling for unknown templates
   - Pass `role_instructions` to spawn_teammate

3. **Add list_agent_templates MCP tool** (after spawn_teammate_tool):
   ```python
   @mcp.tool
   def list_agent_templates() -> list[dict]:
       """List all available agent templates with their name and description.
       Templates provide role-specific system prompts for spawned agents.
       Use the template name with spawn_teammate's template parameter."""
       return list_templates()
   ```

Add to `tests/test_server.py`:

**Class TestListAgentTemplates:**
- `test_returns_all_four_templates`: Call list_agent_templates tool, parse result, assert len >= 4, all entries have "name" and "description" keys, names include researcher/implementer/reviewer/tester.
- `test_returns_list_of_dicts`: Verify result is a list where each entry is a dict.

**Class TestSpawnWithTemplateTool:**
- `test_spawn_with_researcher_template`: Mock spawn_teammate, call spawn_teammate_tool with template="researcher", verify spawn_teammate was called with role_instructions containing "# Role: Researcher" and subagent_type="researcher".
- `test_spawn_with_unknown_template_raises_error`: Call spawn_teammate_tool with template="nonexistent" (use raise_on_error=False), verify is_error is True and response text contains "Unknown template" and lists available templates.
- `test_spawn_without_template_uses_general_purpose`: Mock spawn_teammate, call spawn_teammate_tool without template param, verify spawn_teammate was called with subagent_type="general-purpose" and role_instructions="" (empty).
- `test_spawn_template_sets_subagent_type`: Mock spawn_teammate, call with template="tester", verify subagent_type kwarg is "tester".

Follow existing TestModelTranslationWiring pattern for mocking spawn_teammate: use `unittest.mock.patch("claude_teams.server.spawn_teammate")` and return a mock TeammateMember, then inspect call_args.
  </action>
  <verify>
Run `python -m pytest tests/test_server.py -v` -- all tests pass (existing + 6 new).
Run `python -m pytest tests/test_server.py::TestListAgentTemplates tests/test_server.py::TestSpawnWithTemplateTool -v` -- 6 new tests pass.
Run `python -m pytest tests/ -v` -- full suite passes.
  </verify>
  <done>
spawn_teammate_tool accepts optional template parameter that resolves to role_instructions via template registry. Unknown templates raise ToolError with available template names. list_agent_templates MCP tool returns all 4 templates. subagent_type is derived from template name. 6 new server tests pass. All existing server tests pass (backward compatible since subagent_type was replaced by template with default "").
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_spawner.py tests/test_server.py -v` -- all tests pass
2. `python -m pytest tests/ -v` -- full test suite passes
3. Verify template wiring end-to-end: `python -c "from claude_teams.templates import get_template; t = get_template('researcher'); assert '# Role: Researcher' in t.role_instructions; print('template lookup OK')"`
4. Verify list tool is importable: `python -c "from claude_teams.server import mcp; print('server imports OK')"`
5. Verify spawn_teammate accepts new params: `python -c "import inspect; from claude_teams.spawner import spawn_teammate; sig = inspect.signature(spawn_teammate); assert 'role_instructions' in sig.parameters; assert 'custom_instructions' in sig.parameters; print('spawn params OK')"`
</verification>

<success_criteria>
- spawn_teammate() forwards role_instructions and custom_instructions to generate_agent_config()
- spawn_teammate_tool resolves template name to role_instructions via get_template()
- Unknown template names produce ToolError with list of available templates
- Spawning without template preserves pre-Phase-6 behavior (subagent_type="general-purpose", no role instructions)
- list_agent_templates MCP tool returns 4 templates with name and description
- All existing tests pass unchanged
- All new tests pass
- Full test suite has zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-templates/06-02-SUMMARY.md`
</output>
