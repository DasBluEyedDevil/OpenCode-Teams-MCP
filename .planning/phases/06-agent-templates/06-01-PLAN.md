---
phase: 06-agent-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/templates.py
  - src/claude_teams/config_gen.py
  - tests/test_templates.py
  - tests/test_config_gen.py
autonomous: true

must_haves:
  truths:
    - "4 pre-built templates exist: researcher, implementer, reviewer, tester"
    - "Each template has a name, description, and non-empty role_instructions"
    - "Templates are frozen/immutable dataclass instances"
    - "get_template returns a template by name or None for unknown names"
    - "list_templates returns all templates with name and description"
    - "generate_agent_config accepts optional role_instructions and custom_instructions"
    - "role_instructions appear between Identity and Communication Protocol sections"
    - "custom_instructions appear after role_instructions and before Communication Protocol"
    - "Omitting role_instructions and custom_instructions produces identical output to current behavior"
  artifacts:
    - path: "src/claude_teams/templates.py"
      provides: "AgentTemplate dataclass, TEMPLATES registry, get_template(), list_templates()"
      contains: "TEMPLATES"
    - path: "tests/test_templates.py"
      provides: "Template registry unit tests"
      contains: "TestTemplateRegistry"
    - path: "src/claude_teams/config_gen.py"
      provides: "Extended generate_agent_config with role_instructions and custom_instructions params"
      contains: "role_instructions"
    - path: "tests/test_config_gen.py"
      provides: "Extended config gen tests for template injection"
      contains: "TestGenerateAgentConfigWithTemplate"
  key_links:
    - from: "src/claude_teams/templates.py"
      to: "src/claude_teams/config_gen.py"
      via: "role_instructions string passed from template to config gen"
      pattern: "role_instructions"
---

<objective>
Create the template data model, define 4 built-in role templates, and extend generate_agent_config() to accept template content injection.

Purpose: Establishes the template registry and config generation extension that Plan 02 will wire into the spawn flow and MCP tools. This is the data layer -- templates as frozen dataclass constants, and the config generator that knows how to inject them.

Output: templates.py module, extended config_gen.py, comprehensive tests for both.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-templates/06-RESEARCH.md
@src/claude_teams/config_gen.py
@tests/test_config_gen.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates.py with AgentTemplate dataclass and 4 built-in templates</name>
  <files>src/claude_teams/templates.py, tests/test_templates.py</files>
  <action>
Create `src/claude_teams/templates.py` with:

1. **AgentTemplate dataclass** (frozen=True):
   - `name: str` -- template identifier (e.g., "researcher")
   - `description: str` -- one-line description for listing
   - `role_instructions: str` -- markdown text injected into agent config system prompt
   - `tool_overrides: dict[str, bool] = field(default_factory=dict)` -- reserved for future use, empty for all v1 templates

2. **TEMPLATES registry** (`dict[str, AgentTemplate]`):
   Four entries keyed by name. Use `textwrap.dedent` for role_instructions. Each template's role_instructions should:
   - Start with `# Role: {Name}` heading
   - Have a bold one-line role summary
   - Include "Core Behaviors" section (5 bullet points of behavioral guidance)
   - Include "Working Style" section (4-5 bullet points)
   - Include "Tool Priorities" section (Heavy/Moderate/Light use categorization)
   - Use behavioral guidance, NOT hard tool restrictions (say "focus on testing" not "disable write tool")
   - Keep each template between 15-30 lines of dedented text

   Templates to define (see 06-RESEARCH.md Pattern 1 for exact content):
   - **researcher**: Research and investigation specialist. Heavy use: read, grep, glob, websearch, webfetch. Light use: write/edit.
   - **implementer**: Code implementation specialist. Heavy use: read, write, edit, bash. Moderate: grep, glob.
   - **reviewer**: Code review and quality specialist. Heavy use: read, grep, glob. Avoid: write, edit (report issues, don't fix them).
   - **tester**: Testing and QA specialist. Heavy use: read, write, edit, bash. Moderate: grep, glob.

3. **get_template(name: str) -> AgentTemplate | None**: Dict lookup, returns None for unknown names.

4. **list_templates() -> list[dict[str, str]]**: Returns list of `{"name": ..., "description": ...}` for all templates.

Create `tests/test_templates.py` with class `TestTemplateRegistry`:
- `test_has_four_required_templates` -- {"researcher", "implementer", "reviewer", "tester"} is a subset of TEMPLATES.keys()
- `test_all_templates_are_agent_template_instances` -- isinstance check
- `test_all_templates_have_nonempty_role_instructions` -- strip().len() > 0
- `test_all_templates_have_nonempty_description` -- strip().len() > 0
- `test_get_template_returns_template` -- get_template("researcher") returns AgentTemplate with name "researcher"
- `test_get_template_returns_none_for_unknown` -- get_template("nonexistent") is None
- `test_list_templates_returns_all` -- len >= 4, all have "name" and "description" keys
- `test_templates_are_frozen` -- assigning to tmpl.name raises AttributeError (via FrozenInstanceError)
- `test_role_instructions_contain_role_heading` -- each template's role_instructions contains "# Role:"
- `test_tool_overrides_empty_for_v1` -- all templates have empty tool_overrides dict
  </action>
  <verify>
Run `python -m pytest tests/test_templates.py -v` -- all tests pass.
Run `python -c "from claude_teams.templates import TEMPLATES, get_template, list_templates; print(len(TEMPLATES), len(list_templates()))"` -- prints "4 4".
  </verify>
  <done>
templates.py exists with AgentTemplate dataclass and 4 frozen template instances. get_template() and list_templates() work correctly. All 10 template tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend generate_agent_config with role_instructions and custom_instructions parameters</name>
  <files>src/claude_teams/config_gen.py, tests/test_config_gen.py</files>
  <action>
Modify `generate_agent_config()` in `src/claude_teams/config_gen.py`:

1. **Add two optional parameters** to the function signature:
   ```python
   def generate_agent_config(
       agent_id: str,
       name: str,
       team_name: str,
       color: str,
       model: str,
       role_instructions: str = "",
       custom_instructions: str = "",
   ) -> str:
   ```

2. **Restructure the body construction** to use a list of parts joined by newlines, instead of the current single f-string. This enables conditional section injection:
   - Part 1: Agent Identity section (existing -- `# Agent Identity` with name, team, agent_id, color)
   - Part 2: Role instructions (NEW -- only if `role_instructions` is non-empty, inject the string as-is with no extra wrapping)
   - Part 3: Custom instructions (NEW -- only if `custom_instructions` is non-empty, wrap in `# Additional Instructions` heading followed by the custom text)
   - Part 4: Communication Protocol section (existing -- `# Communication Protocol` with inbox polling and sending messages)
   - Part 5: Task Management section (existing -- `# Task Management`)
   - Part 6: Shutdown Protocol section (existing -- `# Shutdown Protocol`)

3. **Section ordering matters** (research confirmed LLM primacy bias): Role instructions MUST appear before Communication Protocol so role-specific behavior has higher prompt priority.

4. **Backward compatibility**: When both role_instructions and custom_instructions are empty strings (the default), the output MUST be identical to the current function output. Do NOT change existing section content or whitespace. The simplest approach: keep each existing section as its own `textwrap.dedent(f"""...""").strip()` block, append to a list, then join with `\n\n`.

Add to `tests/test_config_gen.py` a new test class `TestGenerateAgentConfigWithTemplate`:
- `test_role_instructions_injected_in_body` -- pass role_instructions="# Role: Researcher\n\nYou focus on research.", verify both strings appear in body
- `test_role_instructions_appear_before_communication_protocol` -- body.index("# Role: Researcher") < body.index("# Communication Protocol")
- `test_custom_instructions_injected_in_body` -- pass custom_instructions="Focus on Python type hints.", verify it appears in body
- `test_custom_instructions_wrapped_with_heading` -- verify "# Additional Instructions" appears before custom text
- `test_custom_instructions_appear_after_role_instructions` -- pass both, verify ordering
- `test_custom_instructions_appear_before_communication_protocol` -- verify "Additional Instructions" comes before "Communication Protocol"
- `test_no_template_preserves_existing_behavior` -- call with no role_instructions/custom_instructions, verify body contains Identity, Communication Protocol, Task Management, Shutdown Protocol sections and does NOT contain "Additional Instructions" or "# Role:"
- `test_role_instructions_only_no_custom` -- pass role_instructions without custom_instructions, verify role content appears, no "Additional Instructions" heading
- `test_custom_instructions_only_no_role` -- pass custom_instructions without role_instructions, verify custom content appears with heading

Use the existing `_extract_frontmatter` and `_extract_body` helpers from TestGenerateAgentConfig (copy them into the new class or use a shared mixin/base approach -- whichever matches existing test file conventions; the simplest approach is to duplicate the two helper methods).
  </action>
  <verify>
Run `python -m pytest tests/test_config_gen.py -v` -- ALL tests pass (both existing 19 + new 9 = 28+ tests).
Run `python -m pytest tests/ -v` -- full test suite passes (no regressions).
  </verify>
  <done>
generate_agent_config() accepts role_instructions and custom_instructions parameters. Role instructions are injected between Identity and Communication Protocol. Custom instructions are wrapped with "# Additional Instructions" heading. Backward compatibility is verified: existing tests pass without changes. 9 new config gen tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_templates.py tests/test_config_gen.py -v` -- all tests pass
2. `python -m pytest tests/ -v` -- full suite passes, no regressions from config_gen changes
3. `python -c "from claude_teams.templates import TEMPLATES; print(sorted(TEMPLATES.keys()))"` -- prints ['implementer', 'researcher', 'reviewer', 'tester']
4. `python -c "from claude_teams.config_gen import generate_agent_config; c = generate_agent_config('a@t', 'a', 't', 'blue', 'm'); assert '# Communication Protocol' in c; print('backward compat OK')"` -- no error
</verification>

<success_criteria>
- templates.py exists with 4 frozen AgentTemplate instances
- config_gen.py accepts role_instructions and custom_instructions
- Role instructions appear between Identity and Communication Protocol
- Custom instructions appear with heading, after role instructions
- All existing config_gen tests pass unchanged (backward compatibility)
- All new template and config gen tests pass
- Full test suite has zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-templates/06-01-SUMMARY.md`
</output>
