---
phase: 08-legacy-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/claude_teams/spawner.py
  - tests/test_spawner.py
  - src/claude_teams/server.py
autonomous: true

must_haves:
  truths:
    - "discover_claude_binary() no longer exists in the codebase"
    - "build_spawn_command() no longer exists in the codebase"
    - "No Claude Code CLI flags (--agent-id, --team-name, --parent-session-id) appear in source code"
    - "spawn_teammate() does not accept a lead_session_id parameter"
    - "All existing tests pass after deletions"
  artifacts:
    - path: "src/claude_teams/spawner.py"
      provides: "Spawner module without Claude-specific functions"
      contains: "def discover_opencode_binary"
    - path: "tests/test_spawner.py"
      provides: "Spawner tests without Claude-specific test classes"
      contains: "class TestBuildOpencodeRunCommand"
    - path: "src/claude_teams/server.py"
      provides: "Server calling spawn_teammate without lead_session_id"
      contains: "spawn_teammate("
  key_links:
    - from: "src/claude_teams/server.py"
      to: "src/claude_teams/spawner.py"
      via: "spawn_teammate call"
      pattern: "spawn_teammate\\("
---

<objective>
Remove all Claude Code-specific functions and dead parameters from the spawner module and update all callers.

Purpose: CLEAN-01, CLEAN-02, CLEAN-03 require removal of `discover_claude_binary()`, `build_spawn_command()`, and all Claude Code CLI flags. CLEAN-04 (partial) requires removing the dead `lead_session_id` parameter.
Output: spawner.py, test_spawner.py, and server.py with zero Claude-specific functions or dead parameters.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-legacy-cleanup/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete discover_claude_binary, build_spawn_command, and their tests</name>
  <files>
    src/claude_teams/spawner.py
    tests/test_spawner.py
  </files>
  <action>
In `src/claude_teams/spawner.py`:
- Delete the `discover_claude_binary()` function (lines 119-126)
- Delete the `build_spawn_command()` function (lines 135-155)

In `tests/test_spawner.py`:
- Remove `discover_claude_binary` and `build_spawn_command` from the import block (line 18: `build_spawn_command`, line 23: `discover_claude_binary`)
- Delete the entire `TestDiscoverClaudeBinary` class (lines 80-92)
- Delete the entire `TestBuildSpawnCommand` class (lines 108-130)

IMPORTANT: Do NOT delete `_make_member()` (lines 59-77). It is still used by `TestAssignColor` (line 101) and `TestCheckSingleAgentHealth`. Leave it in place.
IMPORTANT: Keep `TestBuildOpencodeRunCommand.test_no_claude_flags` -- these negative assertions are still valuable.

Run `pytest tests/test_spawner.py -x` after deletions to catch any ImportError or NameError immediately.
  </action>
  <verify>
Run: `uv run pytest tests/test_spawner.py -x -v`
All tests pass. No ImportError or NameError. `TestDiscoverClaudeBinary` and `TestBuildSpawnCommand` do not appear in output.
  </verify>
  <done>
`discover_claude_binary` and `build_spawn_command` do not exist in spawner.py. Their test classes do not exist in test_spawner.py. All remaining tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove lead_session_id parameter from spawn_teammate and all callers</name>
  <files>
    src/claude_teams/spawner.py
    src/claude_teams/server.py
    tests/test_spawner.py
  </files>
  <action>
The `lead_session_id` parameter is dead code -- it is accepted by `spawn_teammate()` but never used in the function body (the OpenCode path does not reference it).

In `src/claude_teams/spawner.py`:
- Remove `lead_session_id: str,` from `spawn_teammate()` signature (line 192). The parameter after `opencode_binary` should become `*,` (keyword-only marker).

In `src/claude_teams/server.py`:
- Remove `lead_session_id=ls["session_id"],` from the `spawn_teammate()` call in `spawn_teammate_tool()` (line 131).

In `tests/test_spawner.py`:
- Find ALL calls to `spawn_teammate()` and remove the `SESSION_ID` positional argument. These are currently the 5th positional arg. Callers to update:
  - `TestSpawnTeammateNameValidation` (4 tests, lines 216-228): Each calls `spawn_teammate(TEAM, "...", "prompt", "/bin/echo", SESSION_ID, base_dir=...)`. Remove `SESSION_ID`.
  - `TestSpawnTeammate` (4 tests, lines 233-304): Each calls `spawn_teammate(TEAM, "researcher", "...", "...", SESSION_ID, base_dir=...)`. Remove `SESSION_ID`.
  - `TestSpawnWithTemplate` (4 tests, lines 310-423): Each calls `spawn_teammate(TEAM, "...", "...", "...", SESSION_ID, base_dir=...)`. Remove `SESSION_ID`.
  - `TestSpawnDesktopBackend` (4 tests, lines 1034-1115): Each calls `spawn_teammate(TEAM, "...", "...", "...", SESSION_ID, ...)`. Remove `SESSION_ID`.
  - `TestConfigGenIntegration` (2 tests, lines 614-689): Each calls `spawn_teammate(TEAM, "...", "...", "...", SESSION_ID, ...)`. Remove `SESSION_ID`.

After removing `SESSION_ID` from all callers, also check: is the `SESSION_ID` constant at line 50 still needed? Yes -- it is used by `team_dir` fixture which calls `create_team(TEAM, session_id=SESSION_ID, ...)`. Keep it.

Run `uv run pytest -x` (full suite) to catch any remaining callers.
  </action>
  <verify>
Run: `uv run pytest -x -v`
All tests pass. Grep: `lead_session_id` returns zero results in src/ and tests/.
  </verify>
  <done>
`spawn_teammate()` no longer accepts `lead_session_id`. No caller passes it. Full test suite passes. `grep -r lead_session_id src/ tests/` returns nothing.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest -x -v` -- all tests pass
2. `grep -r "discover_claude_binary" src/ tests/` -- zero results
3. `grep -r "build_spawn_command" src/ tests/` -- zero results
4. `grep -r "lead_session_id" src/ tests/` -- zero results
5. `grep -r "\-\-agent-id" src/` -- zero results (test negative assertions in tests/ are OK to keep)
6. `grep -r "\-\-team-name" src/` -- zero results
7. `grep -r "\-\-parent-session-id" src/` -- zero results
</verification>

<success_criteria>
- discover_claude_binary() and build_spawn_command() are gone from source and tests
- lead_session_id parameter is gone from spawn_teammate() and all callers
- All Claude Code CLI flags are gone from source code (negative test assertions in tests/ are OK)
- Full test suite passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/08-legacy-cleanup/08-01-SUMMARY.md`
</output>
